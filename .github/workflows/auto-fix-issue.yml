# NOTE: This file is generated from examples/auto-fix-issue.yml.
# Do not edit this file directly. Instead, edit the example and run:
# npm run gen-workflows

name: Auto Fix Issue
on:
  workflow_call:
    inputs:
      profile:
        description: Optional Warp Agent profile name to use for Warp Agent.
        required: false
        type: string
        default: ''
      model:
        description: Optional Warp model ID to use for Warp Agent.
        required: false
        type: string
        default: ''
      name:
        description: Optional name for this agent task.
        required: false
        type: string
        default: ''
      mcp:
        description:
          Optional MCP configuration in JSON format (or a path to an mcp.json file) to start before
          executing the agent.
        required: false
        type: string
        default: ''
    secrets:
      WARP_API_KEY:
        description: Warp API key used by the Warp Agent.
        required: true
jobs:
  auto_fix:
    if: github.event.label.name == 'warp-agent'
    name: Auto Fix Issue
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Construct Prompt
        id: prompt
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;

            // Fetch all previous comments on the issue to give the agent full context
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              per_page: 100,
            });

            const description = issue.body || 'No description provided.';

            let commentsNote = 'There are no previous comments on this issue.';
            let commentsInstructions = '';
            if (comments.length) {
              const commentsText = comments
                .map(c => `- ${c.user?.login || 'unknown'} (${c.created_at}): ${c.body}`)
                .join('\\n');
              fs.writeFileSync('issue_comments.txt', commentsText, 'utf8');
              commentsNote = 'All previous issue comments are stored in \`issue_comments.txt\` in the workspace.';
              commentsInstructions = `
                -   Optionally, read \`issue_comments.txt\` to understand prior discussion and clarifications.`;
            }

            const prompt = `You are an expert software engineer and the Warp Agent.
            You have been assigned to fix GitHub Issue #${issue.number}.

            **Issue Details**:
            - **Title**: ${issue.title}
            - **Description**: ${description}

            **Previous Issue Comments**:
            ${commentsNote}

            **Instructions**:
            1.  **Analyze**:
                -   Carefully read the issue description above to understand the problem.${commentsInstructions}
            2.  **Fix**: Implement the changes necessary to resolve the issue.
            3.  **Verify**: Ensure the code is correct and follows existing patterns.
            4.  **Output**: Do not output the diff. Provide a brief summary of what you changed.
            `;
            core.setOutput('prompt', prompt);
      - name: Run Warp Agent
        uses: warpdotdev/warp-agent-action@v1
        env:
          GH_TOKEN: ${{ github.token }}
        id: agent
        with:
          prompt: ${{ steps.prompt.outputs.prompt }}
          warp_api_key: ${{ secrets.WARP_API_KEY }}
          profile: ${{ inputs.profile || vars.WARP_AGENT_PROFILE || '' }}
          model: ${{ inputs.model || vars.WARP_AGENT_MODEL || '' }}
          name: ${{ inputs.name || vars.WARP_AGENT_NAME || '' }}
          mcp: ${{ inputs.mcp || vars.WARP_AGENT_MCP || '' }}
      - name: Create PR and Comment
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AGENT_OUTPUT: ${{ steps.agent.outputs.agent_output }}
        run: |
          # Remove temporary files that should not be committed
          rm -f issue_comments.txt issue_description.txt

          # Check for changes
          if [[ -z $(git status --porcelain) ]]; then
            echo "No changes made by Warp Agent."
            gh issue comment "$ISSUE_NUMBER" --body "I analyzed the issue but couldn't determine a code change to make. \\n\\n**Agent Output:**\\n$AGENT_OUTPUT"
            exit 0
          fi

          BRANCH_NAME="fix/issue-$ISSUE_NUMBER"

          git config user.name "Warp Agent"
          git config user.email "agent@warp.dev"

          git checkout -b "$BRANCH_NAME"
          git add .
          git commit -m "Fix for Issue #$ISSUE_NUMBER"
          git push origin "$BRANCH_NAME" --force

          # Create PR
          # Escape title to handle special chars
          TITLE="Fix Issue #$ISSUE_NUMBER: ${{ github.event.issue.title }}"
          BODY="This PR attempts to fix Issue #$ISSUE_NUMBER.

          **Agent Summary**:
          $AGENT_OUTPUT

          Closes #$ISSUE_NUMBER"

          # Create PR and capture URL
          PR_URL=$(gh pr create --title "$TITLE" --body "$BODY" --base main --head "$BRANCH_NAME")

          echo "Created PR: $PR_URL"

          # Comment on Issue
          gh issue comment "$ISSUE_NUMBER" --body "I have created a fix for this issue: $PR_URL"
